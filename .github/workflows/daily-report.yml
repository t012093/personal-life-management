name: Daily Progress Report
on:
  schedule:
    - cron: '0 21 * * *'  # æ¯æ—¥21:00 UTC (ç¿Œæ—¥6:00 JST)
  workflow_dispatch:

jobs:
  generate-report:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Generate Daily Report
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TODAY=$(date '+%Y-%m-%d')
          YESTERDAY=$(date -d "yesterday" '+%Y-%m-%d')
          
          echo "æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆã‚’é–‹å§‹: $TODAY"
          
          # ä»Šæ—¥ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚¿ã‚¹ã‚¯ã®å–å¾—
          TASKS=$(gh issue list --label routine,daily --search "created:$TODAY" --json number,title,body,comments,state,labels -q '.[]')
          
          if [ -z "$TASKS" ]; then
            echo "æœ¬æ—¥ã®ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ã¾ã™ã€‚"
            
            # æ–°ã—ã„æ—¥æ¬¡ã‚¿ã‚¹ã‚¯ã®ä½œæˆ
            TASK_TITLE="[Daily] $TODAY æœæ´»ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³"
            TASK_BODY="## æœ¬æ—¥ã®ç›®æ¨™\n\n* [ ] æœ6æ™‚èµ·åºŠ\n* [ ] ãƒ¢ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¹ãƒˆãƒ¬ãƒƒãƒï¼ˆ15åˆ†ï¼‰\n* [ ] å¥åº·çš„ãªæœé£Ÿ\n* [ ] é‹å‹•ï¼ˆ30åˆ†ï¼‰\n* [ ] é£Ÿäº‹è¨˜éŒ²\n\n## ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«\n\n06:00 - èµ·åºŠ\n06:15 - ãƒ¢ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³\n07:00 - é‹å‹•\n08:00 - æœé£Ÿã¨1æ—¥ã®è¨ˆç”»\n\n## ãƒ¡ãƒ¢"
            
            gh issue create --title "$TASK_TITLE" --label "routine,daily" --body "$TASK_BODY"
            exit 0
          fi
          
          # ã‚¿ã‚¹ã‚¯ã”ã¨ã®é€²æ—ã‚’åˆ†æ
          echo "$TASKS" | jq -c '.[]' | while read -r task; do
            TASK_NUM=$(echo "$task" | jq -r '.number')
            
            # ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®æŠ½å‡º
            WAKEUP_TIME=$(echo "$task" | jq -r '.comments[] | select(contains("å®Ÿéš›ã®èµ·åºŠæ™‚åˆ»")) | capture("å®Ÿéš›ã®èµ·åºŠæ™‚åˆ»ï¼š(?<time>[0-9]{1,2}:[0-9]{2})").time // "æœªè¨˜éŒ²"' | tail -n1)
            EXERCISE_TIME=$(echo "$task" | jq -r '.comments[] | select(contains("é‹å‹•æ™‚é–“")) | capture("æ™‚é–“ï¼š(?<time>[0-9]+)åˆ†").time // "0"' | tail -n1)
            
            # ã‚¿ã‚¹ã‚¯ã®çŠ¶æ…‹ç¢ºèª
            STATUS=$(echo "$task" | jq -r '.state')
            IS_IN_PROGRESS=$(echo "$task" | jq -r '.labels[] | select(.name == "in_progress") | .name' | wc -l)
            
            # é€²æ—ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆ
            REPORT="## ğŸ“‹ ãƒ‡ã‚¤ãƒªãƒ¼ã‚¿ã‚¹ã‚¯é€²æ—ãƒ¬ãƒãƒ¼ãƒˆ\n**æ—¥ä»˜:** $TODAY\n\n"
            
            if [ "$STATUS" = "closed" ]; then
              REPORT="${REPORT}### âœ… ã‚¿ã‚¹ã‚¯å®Œäº†\nãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼æœ¬æ—¥ã®ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ã—ã¾ã—ãŸã€‚\n\n"
            elif [ "$IS_IN_PROGRESS" -gt 0 ]; then
              REPORT="${REPORT}### ğŸƒ ã‚¿ã‚¹ã‚¯å®Ÿè¡Œä¸­\nå¼•ãç¶šãã€ç›®æ¨™é”æˆã«å‘ã‘ã¦é ‘å¼µã‚Šã¾ã—ã‚‡ã†ã€‚\n\n"
            else
              REPORT="${REPORT}### â° ã‚¿ã‚¹ã‚¯é–‹å§‹å‰\næ—©ã‚ã«ã‚¿ã‚¹ã‚¯ã‚’é–‹å§‹ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚\n\n"
            fi
            
            REPORT="${REPORT}### ğŸ“Š ä»Šæ—¥ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹\n- èµ·åºŠæ™‚åˆ»: $WAKEUP_TIME"
            
            if [ "$EXERCISE_TIME" != "0" ]; then
              REPORT="$REPORT\n- é‹å‹•æ™‚é–“: ${EXERCISE_TIME}åˆ†"
            fi
            
            # ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã®å®Œäº†çŠ¶æ³ã‚’ç¢ºèª
            CHECKLIST=$(echo "$task" | jq -r '.body' | grep -E '^\s*[*-] \[([ x])\]')
            TOTAL_TASKS=$(echo "$CHECKLIST" | wc -l)
            COMPLETED_TASKS=$(echo "$CHECKLIST" | grep -c '\[x\]')
            
            if [ "$TOTAL_TASKS" -gt 0 ]; then
              COMPLETION_RATE=$((COMPLETED_TASKS * 100 / TOTAL_TASKS))
              REPORT="$REPORT\n\n### âœ“ ã‚¿ã‚¹ã‚¯é”æˆçŠ¶æ³\n- å®Œäº†ã‚¿ã‚¹ã‚¯: $COMPLETED_TASKS / $TOTAL_TASKS\n- é”æˆç‡: ${COMPLETION_RATE}%"
            fi
            
            REPORT="$REPORT\n\n### ğŸ’¡ ã‚¢ãƒ‰ãƒã‚¤ã‚¹"
            
            if [ "$WAKEUP_TIME" \> "06:30" ]; then
              REPORT="$REPORT\n- ç›®æ¨™ã®èµ·åºŠæ™‚åˆ»ï¼ˆ6:00ï¼‰ã‚ˆã‚Šé…ã‚Œã¦ã„ã¾ã™ã€‚å°±å¯æ™‚é–“ã‚’æ—©ã‚ã‚‹ã“ã¨ã‚’æ¤œè¨ã—ã¾ã—ã‚‡ã†ã€‚"
            fi
            
            if [ "$EXERCISE_TIME" = "0" ]; then
              REPORT="$REPORT\n- ã¾ã é‹å‹•ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚çŸ­æ™‚é–“ã§ã‚‚é‹å‹•ã‚’å–ã‚Šå…¥ã‚Œã¾ã—ã‚‡ã†ã€‚"
            elif [ "$EXERCISE_TIME" -lt 30 ]; then
              REPORT="$REPORT\n- é‹å‹•æ™‚é–“ãŒç›®æ¨™ï¼ˆ30åˆ†ï¼‰ã«é”ã—ã¦ã„ã¾ã›ã‚“ã€‚å¯èƒ½ã§ã‚ã‚Œã°æ™‚é–“ã‚’å¢—ã‚„ã—ã¾ã—ã‚‡ã†ã€‚"
            fi
            
            # ãƒ¬ãƒãƒ¼ãƒˆã®æŠ•ç¨¿
            gh issue comment "$TASK_NUM" --body "$REPORT"
          done

      - name: Update Epic Progress
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Epicã‚¿ã‚¹ã‚¯ã®æ›´æ–°
          EPICS=$(gh issue list --label epic --state open --json number,title -q '.[]')
          
          echo "$EPICS" | jq -c '.[]' | while read -r epic; do
            EPIC_NUM=$(echo "$epic" | jq -r '.number')
            
            # ã‚µãƒ–ã‚¿ã‚¹ã‚¯ã®é€²æ—è¨ˆç®—
            TOTAL=$(gh issue list --search "[#$EPIC_NUM]" --json number -q '. | length')
            COMPLETED=$(gh issue list --search "[#$EPIC_NUM] is:closed" --json number -q '. | length')
            IN_PROGRESS=$(gh issue list --search "[#$EPIC_NUM] label:in_progress" --json number -q '. | length')
            
            PROGRESS=$((COMPLETED * 100 / TOTAL))
            
            # é€²æ—ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆ
            SUMMARY="## ğŸ“ˆ Epicã®é€²æ—çŠ¶æ³ ($TODAY)\n\n### ğŸ“Š ç¾åœ¨ã®çŠ¶æ…‹\n- å…¨ä½“ã‚¿ã‚¹ã‚¯æ•°: $TOTAL\n- å®Œäº†: $COMPLETED\n- é€²è¡Œä¸­: $IN_PROGRESS\n- é€²æ—ç‡: ${PROGRESS}%\n\n"
            
            if [ $PROGRESS -eq 100 ]; then
              SUMMARY="$SUMMARYğŸ‰ **ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼** å…¨ã¦ã®ã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸã€‚"
            elif [ $PROGRESS -ge 80 ]; then
              SUMMARY="$SUMMARYğŸ‘ ç›®æ¨™é”æˆã¾ã§ã‚ã¨å°‘ã—ã§ã™ï¼æœ€å¾Œã¾ã§é ‘å¼µã‚Šã¾ã—ã‚‡ã†ã€‚"
            elif [ $PROGRESS -ge 50 ]; then
              SUMMARY="$SUMMARYğŸ’ª é †èª¿ã«é€²ã‚“ã§ã„ã¾ã™ã€‚ã“ã®ãƒšãƒ¼ã‚¹ã‚’ç¶­æŒã—ã¾ã—ã‚‡ã†ã€‚"
            else
              SUMMARY="$SUMMARYğŸŒ± ä¸€æ­©ä¸€æ­©ã€ç¢ºå®Ÿã«å‰é€²ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚"
            fi
            
            # ãƒ¬ãƒãƒ¼ãƒˆã®æŠ•ç¨¿
            gh issue comment "$EPIC_NUM" --body "$SUMMARY"
          done
