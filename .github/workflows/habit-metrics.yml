name: Habit Metrics Collection
on:
  schedule:
    - cron: '0 21 * * 0'  # æ¯é€±æ—¥æ›œæ—¥ã®21:00 UTC (æœˆæ›œ6:00 JST)
  workflow_dispatch:

jobs:
  analyze-habits:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Generate Weekly Report
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # å…ˆé€±ã®æ—¥ä»˜ç¯„å›²ã‚’è¨ˆç®—
          LAST_SUNDAY=$(date -d "last Sunday" '+%Y-%m-%d')
          WEEK_START=$(date -d "$LAST_SUNDAY -6 days" '+%Y-%m-%d')
          WEEK_END=$LAST_SUNDAY
          
          echo "é›†è¨ˆæœŸé–“: $WEEK_START ã‹ã‚‰ $WEEK_END"
          
          # é€±é–“ãƒ‡ãƒ¼ã‚¿ã®é›†è¨ˆ
          TASKS=$(gh issue list --label routine,daily --search "created:$WEEK_START..$WEEK_END" --json number,title,body,comments,state -q '.[]')
          
          if [ -z "$TASKS" ]; then
            echo "å¯¾è±¡æœŸé–“ã®ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 0
          fi
          
          # ãƒ¡ãƒˆãƒªã‚¯ã‚¹é›†è¨ˆ
          TOTAL_TASKS=$(echo "$TASKS" | jq '. | length')
          COMPLETED_TASKS=$(echo "$TASKS" | jq '[.[] | select(.state=="closed")] | length')
          
          # èµ·åºŠæ™‚é–“ã®åˆ†æ
          WAKEUP_TIMES=$(echo "$TASKS" | jq -r '.[] | 
            .comments[] | 
            select(contains("å®Ÿéš›ã®èµ·åºŠæ™‚åˆ»")) | 
            capture("å®Ÿéš›ã®èµ·åºŠæ™‚åˆ»ï¼š(?<time>[0-9]{1,2}:[0-9]{2})").time' | 
            sort)
          
          # é‹å‹•æ™‚é–“ã®é›†è¨ˆ
          EXERCISE_MINUTES=$(echo "$TASKS" | jq -r '.[] | 
            .comments[] | 
            select(contains("é‹å‹•æ™‚é–“")) | 
            capture("æ™‚é–“ï¼š(?<time>[0-9]+)åˆ†").time' | 
            awk '{sum += $1} END {print sum}')
          
          # é”æˆç‡ã®è¨ˆç®—
          COMPLETION_RATE=$((COMPLETED_TASKS * 100 / TOTAL_TASKS))
          
          # é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆ
          REPORT="## ğŸ“Š é€±æ¬¡ç¿’æ…£ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒ¬ãƒãƒ¼ãƒˆ\n"
          REPORT+="**æœŸé–“:** $WEEK_START ï½ $WEEK_END\n\n"
          
          REPORT+="### ğŸ“ˆ å…¨ä½“ã®é”æˆçŠ¶æ³\n"
          REPORT+="- ç·ã‚¿ã‚¹ã‚¯æ•°: $TOTAL_TASKS\n"
          REPORT+="- å®Œäº†ã‚¿ã‚¹ã‚¯: $COMPLETED_TASKS\n"
          REPORT+="- é”æˆç‡: ${COMPLETION_RATE}%\n\n"
          
          REPORT+="### â° èµ·åºŠæ™‚é–“ã®åˆ†æ\n"
          if [ ! -z "$WAKEUP_TIMES" ]; then
            EARLIEST=$(echo "$WAKEUP_TIMES" | head -n1)
            LATEST=$(echo "$WAKEUP_TIMES" | tail -n1)
            REPORT+="- æœ€æ—©: $EARLIEST\n"
            REPORT+="- æœ€é…: $LATEST\n"
          else
            REPORT+="- ãƒ‡ãƒ¼ã‚¿ãªã—\n"
          fi
          REPORT+="\n"
          
          REPORT+="### ğŸ’ª é‹å‹•ç¿’æ…£\n"
          if [ ! -z "$EXERCISE_MINUTES" ]; then
            REPORT+="- é€±é–“åˆè¨ˆé‹å‹•æ™‚é–“: ${EXERCISE_MINUTES}åˆ†\n"
            REPORT+="- 1æ—¥å¹³å‡: $((EXERCISE_MINUTES / 7))åˆ†\n"
          else
            REPORT+="- ãƒ‡ãƒ¼ã‚¿ãªã—\n"
          fi
          REPORT+="\n"
          
          # æ”¹å–„ææ¡ˆã®ç”Ÿæˆ
          REPORT+="### ğŸ’¡ æ”¹å–„ã®ãƒ’ãƒ³ãƒˆ\n"
          if [ "$COMPLETION_RATE" -lt 50 ]; then
            REPORT+="- ã‚¿ã‚¹ã‚¯ã®é”æˆç‡ãŒä½ã‚ã§ã™ã€‚ã‚ˆã‚Šå°ã•ãªç›®æ¨™ã‹ã‚‰å§‹ã‚ã‚‹ã“ã¨ã‚’æ¤œè¨ã—ã¾ã—ã‚‡ã†ã€‚\n"
          elif [ "$COMPLETION_RATE" -gt 80 ]; then
            REPORT+="- ç´ æ™´ã‚‰ã—ã„é”æˆç‡ã§ã™ï¼ã‚ˆã‚Šé«˜ã„ç›®æ¨™ã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚\n"
          fi
          
          if [ ! -z "$WAKEUP_TIMES" ]; then
            if [[ "$LATEST" > "07:00" ]]; then
              REPORT+="- èµ·åºŠæ™‚é–“ã«ã°ã‚‰ã¤ããŒã‚ã‚Šã¾ã™ã€‚å°±å¯æ™‚é–“ã‚’ä¸€å®šã«ã™ã‚‹ã“ã¨ã§æ”¹å–„ã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚\n"
            else
              REPORT+="- å®‰å®šã—ãŸèµ·åºŠæ™‚é–“ã‚’ç¶­æŒã§ãã¦ã„ã¾ã™ã€‚ã“ã®ç¿’æ…£ã‚’ç¶šã‘ã¾ã—ã‚‡ã†ã€‚\n"
            fi
          fi
          
          if [ ! -z "$EXERCISE_MINUTES" ] && [ "$EXERCISE_MINUTES" -lt 150 ]; then
            REPORT+="- WHOæ¨å¥¨ã®é€±150åˆ†ã®é‹å‹•æ™‚é–“ã«é”ã—ã¦ã„ã¾ã›ã‚“ã€‚å°‘ã—ãšã¤é‹å‹•æ™‚é–“ã‚’å¢—ã‚„ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚\n"
          fi
          
          # Epicèª²é¡Œã®æ¤œç´¢ã¨æ›´æ–°
          EPICS=$(gh issue list --label epic --state open --json number,title -q '.[]')
          
          echo "$EPICS" | jq -c '.[]' | while read -r epic; do
            EPIC_NUM=$(echo "$epic" | jq -r '.number')
            gh issue comment "$EPIC_NUM" --body "$REPORT"
          done
