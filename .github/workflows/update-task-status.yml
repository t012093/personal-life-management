name: Update Task Status
on:
  project_card:
    types: [moved]

jobs:
  update-status:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Get column info
        id: get-column
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COLUMN_ID="${{ github.event.project_card.column_id }}"
          COLUMN_NAME=$(gh api graphql -f query='
            query($column_id: ID!) {
              node(id: $column_id) {
                ... on ProjectColumn {
                  name
                }
              }
            }
            ' -f column_id=$COLUMN_ID --jq '.data.node.name')
          echo "column_name=${COLUMN_NAME}" >> $GITHUB_OUTPUT

      - name: Update task status and labels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COLUMN_NAME: ${{ steps.get-column.outputs.column_name }}
          ISSUE_URL: ${{ github.event.project_card.content_url }}
        run: |
          # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
          IN_PROGRESS_MSG="ğŸŒ… ã‚¿ã‚¹ã‚¯é–‹å§‹\n\n### æœ¬æ—¥ã®ç›®æ¨™\n- [ ] æœ6æ™‚èµ·åºŠ\n- [ ] ãƒ¢ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¹ãƒˆãƒ¬ãƒƒãƒï¼ˆ15åˆ†ï¼‰\n- [ ] å¥åº·çš„ãªæœé£Ÿ\n- [ ] é‹å‹•ï¼ˆ30åˆ†ï¼‰\n- [ ] é£Ÿäº‹è¨˜éŒ²\n\n### ãƒ¡ãƒ¢\n\n### çŠ¶æ…‹æ›´æ–°\n- é–‹å§‹æ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S')\n- æ‹…å½“è€…: ${{ github.actor }}"
          
          REVIEW_MSG="ğŸŒ™ 1æ—¥ã®æŒ¯ã‚Šè¿”ã‚Š\n\n### ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ\n1. ç›®æ¨™æ™‚åˆ»ã®èµ·åºŠ\n   - å®Ÿéš›ã®èµ·åºŠæ™‚åˆ»ï¼š\n   - æ„Ÿæƒ³ï¼š\n\n2. ãƒ¢ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¹ãƒˆãƒ¬ãƒƒãƒ\n   - å®Ÿæ–½å†…å®¹ï¼š\n   - åŠ¹æœï¼š\n\n3. é£Ÿäº‹ç®¡ç†\n   - æœé£Ÿï¼š\n   - æ˜¼é£Ÿï¼š\n   - å¤•é£Ÿï¼š\n\n4. é‹å‹•é”æˆåº¦\n   - é‹å‹•å†…å®¹ï¼š\n   - æ™‚é–“ï¼š\n\n### æ˜æ—¥ã¸ã®æ”¹å–„ç‚¹\n\n### çŠ¶æ…‹æ›´æ–°\n- è¨˜éŒ²æ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S')\n- è¨˜éŒ²è€…: ${{ github.actor }}"
          
          DONE_MSG="âœ¨ æœ¬æ—¥ã®é”æˆå ±å‘Š\n\n### é”æˆçŠ¶æ³\n1. æœã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³\n   - èµ·åºŠæ™‚åˆ»ï¼š\n   - ã‚¹ãƒˆãƒ¬ãƒƒãƒï¼š\n   - æœé£Ÿï¼š\n\n2. é‹å‹•è¨˜éŒ²\n   - å†…å®¹ï¼š\n   - æ™‚é–“ï¼š\n   - æ„Ÿæƒ³ï¼š\n\n3. é£Ÿäº‹è¨˜éŒ²\n   - æœé£Ÿï¼š\n   - æ˜¼é£Ÿï¼š\n   - å¤•é£Ÿï¼š\n   - ã‚«ãƒ­ãƒªãƒ¼ç›®æ¨™ï¼š\n\n### ãƒã‚¤ãƒ©ã‚¤ãƒˆ\n\n### çŠ¶æ…‹æ›´æ–°\n- å®Œäº†æ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S')\n- è¨˜éŒ²è€…: ${{ github.actor }}\n\næ˜æ—¥ã‚‚é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼ğŸ’ª"
          
          # çŠ¶æ…‹ã¨ãƒ©ãƒ™ãƒ«ã®æ›´æ–°
          if [ "$COLUMN_NAME" = "In Progress" ]; then
            gh issue comment "$ISSUE_URL" --body "$IN_PROGRESS_MSG"
            gh issue edit "$ISSUE_URL" --add-label "in_progress" --remove-label "review,completed"
          elif [ "$COLUMN_NAME" = "Review" ]; then
            gh issue comment "$ISSUE_URL" --body "$REVIEW_MSG"
            gh issue edit "$ISSUE_URL" --add-label "review" --remove-label "in_progress,completed"
          elif [ "$COLUMN_NAME" = "Done" ]; then
            gh issue comment "$ISSUE_URL" --body "$DONE_MSG"
            gh issue edit "$ISSUE_URL" --add-label "completed" --remove-label "in_progress,review"
          fi

  notify-parent:
    needs: update-status
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Get column info
        id: get-column
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COLUMN_ID="${{ github.event.project_card.column_id }}"
          COLUMN_NAME=$(gh api graphql -f query='
            query($column_id: ID!) {
              node(id: $column_id) {
                ... on ProjectColumn {
                  name
                }
              }
            }
            ' -f column_id=$COLUMN_ID --jq '.data.node.name')
          echo "column_name=${COLUMN_NAME}" >> $GITHUB_OUTPUT

      - name: Update Parent Epic
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_URL: ${{ github.event.project_card.content_url }}
          COLUMN_NAME: ${{ steps.get-column.outputs.column_name }}
        run: |
          # ã‚¤ã‚·ãƒ¥ãƒ¼ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰è¦ªã‚¿ã‚¹ã‚¯ç•ªå·ã‚’æŠ½å‡º
          ISSUE_TITLE=$(gh issue view "$ISSUE_URL" --json title -q .title)
          if [[ $ISSUE_TITLE =~ \[#([0-9]+)\] ]]; then
            PARENT_ID=${BASH_REMATCH[1]}
            
            # è¦ªã‚¿ã‚¹ã‚¯ã®æ›´æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
            UPDATE_MSG="ğŸ“‹ ã‚µãƒ–ã‚¿ã‚¹ã‚¯é€²æ—å ±å‘Š\n\n### æ›´æ–°å†…å®¹\n- ã‚¿ã‚¹ã‚¯ï¼š$ISSUE_TITLE\n- æ–°ã—ã„çŠ¶æ…‹ï¼š$COLUMN_NAME\n\n### çŠ¶æ…‹è©³ç´°\n- æ›´æ–°æ—¥æ™‚ï¼š$(date '+%Y-%m-%d %H:%M:%S')\n- æ›´æ–°è€…ï¼š${{ github.actor }}\n\n### ã‚¿ã‚¹ã‚¯æ¦‚è¦\n$(gh issue view "$ISSUE_URL" --json body -q .body | head -n 3)"
            
            # è¦ªã‚¿ã‚¹ã‚¯ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
            gh issue comment "$PARENT_ID" --body "$UPDATE_MSG"
            
            # é€²æ—çŠ¶æ³ã®è¨ˆç®—ã¨æ›´æ–°
            TOTAL_SUBTASKS=$(gh issue list --search "[#$PARENT_ID]" --json number -q '. | length')
            COMPLETED_SUBTASKS=$(gh issue list --search "[#$PARENT_ID] is:closed" --json number -q '. | length')
            PROGRESS=$((COMPLETED_SUBTASKS * 100 / TOTAL_SUBTASKS))
            
            PROGRESS_MSG="### ç¾åœ¨ã®é€²æ—çŠ¶æ³\n- å…¨ä½“ã‚¿ã‚¹ã‚¯æ•°ï¼š$TOTAL_SUBTASKS\n- å®Œäº†ã‚¿ã‚¹ã‚¯æ•°ï¼š$COMPLETED_SUBTASKS\n- é€²æ—ç‡ï¼š${PROGRESS}%"
            gh issue comment "$PARENT_ID" --body "$PROGRESS_MSG"
          fi
